<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修正后的单位统计逻辑测试</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
            margin: 20px; 
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: white; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #1890ff; 
            text-align: center; 
            margin-bottom: 30px;
        }
        .section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid #e8e8e8; 
            border-radius: 6px;
            background: #fafafa;
        }
        .section h3 { 
            color: #333; 
            margin-top: 0; 
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .correction-note {
            background: #fff7e6;
            border: 1px solid #ffd591;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #faad14;
        }
        .logic-flow {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .logic-flow h4 {
            color: #1890ff;
            margin-top: 0;
        }
        .scenario {
            background: white;
            border: 1px solid #d9d9d9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .scenario h5 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .example-data {
            background: #f6f6f6;
            border: 1px solid #d9d9d9;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .expected-result {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .expected-result h6 {
            color: #52c41a;
            margin: 0 0 5px 0;
        }
        ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        li {
            margin-bottom: 8px;
        }
        .highlight {
            background: #fff1b8;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✅ 修正后的单位统计逻辑测试</h1>
        
        <div class="correction-note">
            <h4>🔧 业务逻辑修正</h4>
            <p><strong>重要理解</strong>：在国网组织架构中，<span class="highlight">省份级单位（如"山东"、"江苏"）就是二级单位</span>，只有在选择了具体公司类型或公司类型+批次时，才会展示更细分的下属单位（如科研院、产业集团等）。</p>
        </div>

        <div class="section">
            <h3>📊 修正后的数据处理逻辑</h3>
            
            <div class="logic-flow">
                <h4>💡 新的处理逻辑</h4>
                <ol>
                    <li><strong>默认情况</strong>：省份名称（如"山东"、"江苏"）= 二级单位，正常展示</li>
                    <li><strong>细分情况</strong>：当有更细分的单位时（如"电力科学研究院"、"经济技术研究院"），图表标题显示为"下属单位分布"</li>
                    <li><strong>统计计算</strong>：覆盖二级单位数量 = 有录取人数的有效单位数量</li>
                    <li><strong>数据展示</strong>：直接使用unit_statistics.units中的所有有效数据</li>
                </ol>
            </div>

            <div class="scenario">
                <h5>场景1：默认查询（无具体筛选条件）</h5>
                <div class="example-data">
{
  "unit_statistics": {
    "covered_units": 52,
    "units": [
      {"unit_name": "山东", "recruitment_count": 1283, "percentage": 6.46, "region": "华东"},
      {"unit_name": "新疆", "recruitment_count": 1186, "percentage": 5.97, "region": "西北"},
      {"unit_name": "江苏", "recruitment_count": 1159, "percentage": 5.84, "region": "华东"}
      // ... 更多省份
    ]
  }
}
                </div>
                <div class="expected-result">
                    <h6>预期展示效果：</h6>
                    <ul>
                        <li>图表标题：<strong>"二级单位分布"</strong></li>
                        <li>覆盖单位数量：<strong>52</strong>（来自covered_units字段）</li>
                        <li>图表内容：展示山东、新疆、江苏等省份的录取分布</li>
                        <li>Tooltip：显示单位名称、地区、录取人数、占比</li>
                    </ul>
                </div>
            </div>

            <div class="scenario">
                <h5>场景2：选择了公司类型+批次（有细分单位）</h5>
                <div class="example-data">
{
  "unit_statistics": {
    "covered_units": 15,
    "units": [
      {"unit_name": "电力科学研究院", "recruitment_count": 164, "percentage": 0.83, "region": "未知"},
      {"unit_name": "经济技术研究院", "recruitment_count": 58, "percentage": 0.29, "region": "未知"},
      {"unit_name": "信通产业集团", "recruitment_count": 231, "percentage": 1.16, "region": "未知"},
      {"unit_name": "客服中心", "recruitment_count": 15, "percentage": 0.08, "region": "未知"}
      // ... 更多细分单位
    ]
  }
}
                </div>
                <div class="expected-result">
                    <h6>预期展示效果：</h6>
                    <ul>
                        <li>图表标题：<strong>"下属单位分布"</strong></li>
                        <li>覆盖单位数量：<strong>15</strong></li>
                        <li>图表内容：展示电力科研院、经研院、产业集团等下属单位</li>
                        <li>Tooltip：显示单位全名和录取情况</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>🔍 关键修改点</h3>
            
            <div class="scenario">
                <h5>1. secondaryUnitsCount 计算逻辑</h5>
                <div class="example-data">
// 修正前：复杂的单位类型判断和过滤
// 修正后：直接使用covered_units或统计有效单位数量

const secondaryUnitsCount = computed(() => {
  // 优先使用新的unit_statistics.covered_units字段
  if (props.data?.analytics?.unit_statistics?.covered_units !== undefined) {
    return props.data.analytics.unit_statistics.covered_units
  }
  
  // 如果有unit_statistics.units数据，统计有效单位数量
  if (props.data?.analytics?.unit_statistics?.units) {
    const units = props.data.analytics.unit_statistics.units
    // 过滤掉录取人数为0的单位
    const validUnits = units.filter((unit: any) => (unit.recruitment_count || 0) > 0)
    return validUnits.length
  }
  
  // 兼容旧数据结构...
})
                </div>
            </div>

            <div class="scenario">
                <h5>2. regionChartTitle 标题逻辑</h5>
                <div class="example-data">
// 修正后：基于单位类型智能判断标题

const regionChartTitle = computed(() => {
  if (!props.data?.analytics?.unit_statistics?.units) return '二级单位分布'
  
  const units = props.data.analytics.unit_statistics.units
  const provinceLevelKeywords = ['山东', '江苏', '浙江', ...]
  
  // 检查是否有更细分的单位（如具体的分公司、研究院等）
  const hasSubUnits = units.some((unit: any) => {
    const unitName = unit.unit_name || ''
    if (provinceLevelKeywords.includes(unitName)) return false
    return unitName.includes('电力科学研究院') || 
           unitName.includes('经济技术研究院') || 
           unitName.includes('分公司') || unitName.includes('分部') ||
           unitName.includes('产业集团') || unitName.includes('客服中心')
  })
  
  return hasSubUnits ? '下属单位分布' : '二级单位分布'
})
                </div>
            </div>

            <div class="scenario">
                <h5>3. initRegionChart 图表数据处理</h5>
                <div class="example-data">
// 修正后：不再过滤省份数据，直接使用所有有效单位

if (props.data.analytics?.unit_statistics?.units) {
  const units = props.data.analytics.unit_statistics.units
  
  // 直接使用所有有效的单位数据（包括省份作为二级单位）
  data = units
    .filter((unit: any) => (unit.recruitment_count || 0) > 0)
    .map((unit: any) => ({
      name: unit.unit_name || '未知',
      value: unit.recruitment_count || 0,
      region: unit.region || '未知',
      percentage: unit.percentage || 0
    }))
}

// 排序并取前10名
data = data.sort((a, b) => b.value - a.value).slice(0, 10)
                </div>
            </div>
        </div>

        <div class="section">
            <h3>✅ 测试验证清单</h3>
            
            <div class="logic-flow">
                <h4>功能验证项目</h4>
                <ul>
                    <li>✅ <strong>省份数据正确展示</strong>：山东、江苏等省份作为二级单位正常显示</li>
                    <li>✅ <strong>统计数字准确</strong>：覆盖二级单位数量与实际数据匹配</li>
                    <li>✅ <strong>图表标题智能</strong>：根据数据内容显示"二级单位分布"或"下属单位分布"</li>
                    <li>✅ <strong>Tooltip信息完整</strong>：显示单位名称、地区、录取人数、占比</li>
                    <li>✅ <strong>数据排序正确</strong>：按录取人数降序排列，取前10名</li>
                    <li>✅ <strong>点击事件正常</strong>：点击图表项触发正确的钻取事件</li>
                </ul>
            </div>

            <div class="expected-result">
                <h6>🎯 预期改进效果</h6>
                <ol>
                    <li><strong>业务逻辑正确</strong>：省份作为二级单位得到正确识别和展示</li>
                    <li><strong>用户体验提升</strong>：图表标题和内容与实际数据匹配</li>
                    <li><strong>数据展示准确</strong>：统计数字与实际情况一致</li>
                    <li><strong>功能扩展性好</strong>：支持不同查询条件下的数据展示</li>
                </ol>
            </div>
        </div>

        <div class="section">
            <h3>🚀 测试建议</h3>
            
            <div class="scenario">
                <h5>测试步骤</h5>
                <ol>
                    <li><strong>默认查询测试</strong>：不选择任何筛选条件，验证二级单位分布图表显示省份数据</li>
                    <li><strong>公司类型筛选测试</strong>：选择具体的公司类型，观察是否显示更细分的下属单位</li>
                    <li><strong>批次筛选测试</strong>：选择公司类型+批次，验证下属单位分布的展示</li>
                    <li><strong>统计数字验证</strong>：检查"覆盖二级单位"数量是否与实际数据匹配</li>
                    <li><strong>交互功能测试</strong>：点击图表中的单位，验证钻取功能是否正常</li>
                </ol>
            </div>

            <div class="expected-result">
                <h6>📊 关键验证点</h6>
                <ul>
                    <li>确认"山东"、"江苏"等省份在图表中正常显示</li>
                    <li>确认图表标题根据数据类型正确显示</li>
                    <li>确认覆盖单位统计数字准确（应为52）</li>
                    <li>确认Tooltip显示完整信息（含地区和占比）</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>