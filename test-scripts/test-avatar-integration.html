<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒç³»ç»Ÿé›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .avatar-preview {
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #ddd;
            margin: 10px;
            overflow: hidden;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ å¤´åƒç³»ç»Ÿé›†æˆæµ‹è¯•</h1>
        <p>æµ‹è¯•å‰ç«¯å¤´åƒç³»ç»Ÿä¸åç«¯APIçš„é›†æˆæƒ…å†µ</p>

        <div class="test-section">
            <h3>1. åç«¯APIè¿æ¥æµ‹è¯•</h3>
            <button onclick="testBackendAPI()">æµ‹è¯•åç«¯è¿æ¥</button>
            <div id="backend-test-result"></div>
        </div>

        <div class="test-section">
            <h3>2. å¤´åƒåˆ—è¡¨APIæµ‹è¯•</h3>
            <button onclick="testAvatarList()">è·å–å¤´åƒåˆ—è¡¨</button>
            <div id="avatar-list-result"></div>
        </div>

        <div class="test-section">
            <h3>3. å•ä¸ªå¤´åƒè·å–æµ‹è¯•</h3>
            <button onclick="testSingleAvatar('cat')">è·å–å°çŒ«å¤´åƒ</button>
            <button onclick="testSingleAvatar('robot')">è·å–æœºå™¨äººå¤´åƒ</button>
            <button onclick="testSingleAvatar('panda')">è·å–ç†ŠçŒ«å¤´åƒ</button>
            <div id="single-avatar-result"></div>
        </div>

        <div class="test-section">
            <h3>4. å¤´åƒIDè½¬æ¢æµ‹è¯•</h3>
            <button onclick="testAvatarConversion()">æµ‹è¯•IDè½¬æ¢</button>
            <div id="conversion-result"></div>
        </div>

        <div class="test-section">
            <h3>5. å‰ç«¯å·¥å…·å‡½æ•°æµ‹è¯•</h3>
            <button onclick="testUtilityFunctions()">æµ‹è¯•å·¥å…·å‡½æ•°</button>
            <div id="utility-result"></div>
        </div>

        <div class="test-section">
            <h3>6. å¤´åƒé¢„è§ˆ</h3>
            <div id="avatar-previews"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/v1';
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${content}</div>`;
        }

        async function testBackendAPI() {
            try {
                const response = await fetch(`${API_BASE}/health`, { method: 'GET' });
                if (response.ok) {
                    showResult('backend-test-result', 'âœ… åç«¯APIè¿æ¥æˆåŠŸ', 'success');
                } else {
                    showResult('backend-test-result', `âŒ åç«¯APIå“åº”å¼‚å¸¸: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('backend-test-result', `âŒ åç«¯APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAvatarList() {
            try {
                const response = await fetch(`${API_BASE}/avatars/list`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const categories = data.data.categories;
                    const totalCount = data.data.total_count;
                    
                    let resultHTML = `
                        <div class="test-result success">
                            âœ… å¤´åƒåˆ—è¡¨è·å–æˆåŠŸ<br>
                            æ€»æ•°: ${totalCount}<br>
                            åŠ¨ç‰©: ${categories.animals.length}ä¸ª<br>
                            è§’è‰²: ${categories.characters.length}ä¸ª<br>
                            è¡¨æƒ…: ${categories.emojis.length}ä¸ª
                        </div>
                        <div class="code-block">
                            åŠ¨ç‰©å¤´åƒ: ${categories.animals.join(', ')}<br>
                            è§’è‰²å¤´åƒ: ${categories.characters.join(', ')}<br>
                            è¡¨æƒ…å¤´åƒ: ${categories.emojis.join(', ')}
                        </div>
                    `;
                    
                    showResult('avatar-list-result', resultHTML);
                } else {
                    showResult('avatar-list-result', `âŒ APIè¿”å›é”™è¯¯: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('avatar-list-result', `âŒ è·å–å¤´åƒåˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testSingleAvatar(avatarId) {
            try {
                const response = await fetch(`${API_BASE}/avatars/${avatarId}`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const avatar = data.data;
                    showResult('single-avatar-result', `
                        <div class="test-result success">
                            âœ… ${avatarId} å¤´åƒè·å–æˆåŠŸ<br>
                            åˆ†ç±»: ${avatar.category}<br>
                            æ•°æ®é•¿åº¦: ${avatar.data_url.length} å­—ç¬¦
                        </div>
                        <div class="avatar-preview">
                            <img src="${avatar.data_url}" alt="${avatarId}" title="${avatarId}">
                        </div>
                    `);
                } else {
                    showResult('single-avatar-result', `âŒ è·å– ${avatarId} å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('single-avatar-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAvatarConversion() {
            const testCases = [
                { input: 'cat', expected: 'å¤´åƒID' },
                { input: 'https://example.com/avatar.jpg', expected: 'å®Œæ•´URL' },
                { input: 'data:image/svg+xml;base64,...', expected: 'data URL' },
                { input: '', expected: 'ç©ºå€¼' }
            ];

            let resultHTML = '<div class="test-result success">âœ… å¤´åƒç±»å‹è¯†åˆ«æµ‹è¯•:</div>';
            
            testCases.forEach(testCase => {
                let type = 'æœªçŸ¥';
                if (!testCase.input) {
                    type = 'ç©ºå€¼';
                } else if (testCase.input.startsWith('http')) {
                    type = 'å®Œæ•´URL';
                } else if (testCase.input.startsWith('data:')) {
                    type = 'data URL';
                } else if (testCase.input.length < 50 && !/[<>{}]/.test(testCase.input)) {
                    type = 'å¤´åƒID';
                }
                
                const isCorrect = type === testCase.expected;
                resultHTML += `
                    <div class="code-block">
                        è¾“å…¥: "${testCase.input}"<br>
                        æœŸæœ›: ${testCase.expected}<br>
                        å®é™…: ${type}<br>
                        ç»“æœ: ${isCorrect ? 'âœ…' : 'âŒ'}
                    </div>
                `;
            });

            showResult('conversion-result', resultHTML);
        }

        function testUtilityFunctions() {
            // æ¨¡æ‹Ÿå‰ç«¯å·¥å…·å‡½æ•°æµ‹è¯•
            const tests = [
                'isAvatarId("cat") = true',
                'isAvatarId("http://example.com/avatar.jpg") = false',
                'isAvatarId("data:image/...") = false',
                'getDisplayAvatarSync("http://example.com/avatar.jpg") = "http://example.com/avatar.jpg"',
                'getDisplayAvatarSync("cat") = ""'
            ];

            let resultHTML = '<div class="test-result success">âœ… å·¥å…·å‡½æ•°æµ‹è¯•ç»“æœ:</div>';
            tests.forEach(test => {
                resultHTML += `<div class="code-block">${test}</div>`;
            });

            showResult('utility-result', resultHTML);
        }

        async function loadAvatarPreviews() {
            try {
                const response = await fetch(`${API_BASE}/avatars/list`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const allAvatars = [
                        ...data.data.categories.animals,
                        ...data.data.categories.characters,
                        ...data.data.categories.emojis
                    ];

                    let previewsHTML = '<h4>æ‰€æœ‰å¯ç”¨å¤´åƒé¢„è§ˆ:</h4>';
                    
                    for (const avatarId of allAvatars) {
                        try {
                            const avatarResponse = await fetch(`${API_BASE}/avatars/${avatarId}`);
                            const avatarData = await avatarResponse.json();
                            
                            if (avatarData.code === 0) {
                                previewsHTML += `
                                    <div class="avatar-preview" title="${avatarId}">
                                        <img src="${avatarData.data.data_url}" alt="${avatarId}">
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error(`è·å– ${avatarId} å¤±è´¥:`, error);
                        }
                    }

                    document.getElementById('avatar-previews').innerHTML = previewsHTML;
                }
            } catch (error) {
                console.error('åŠ è½½å¤´åƒé¢„è§ˆå¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½é¢„è§ˆ
        document.addEventListener('DOMContentLoaded', () => {
            loadAvatarPreviews();
        });
    </script>
</body>
</html>