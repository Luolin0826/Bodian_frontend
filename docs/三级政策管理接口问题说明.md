# 三级政策管理系统接口问题说明

## 发现的主要问题

### 1. 参数传递不一致
**问题描述：**
- 在导航树组件中使用 `parent_id` + `region_level` 获取子节点
- 在复制政策功能中使用 `province` 参数获取同省公司
- 两种方式可能返回不同的数据结构

**解决方案：**
```javascript
// 统一的参数结构
{
  region_level: 'province' | 'city' | 'company',
  parent_id?: number,      // 用于层级查询
  province?: string,       // 用于按省份过滤
  city?: string           // 用于按城市过滤
}
```

### 2. 数据层级关系问题
**预期结构：**
```
省份 (province)
└── 城市 (city)
    └── 区县公司 (company)
```

**接口调用流程：**
1. 获取所有省份：`getRegions({ region_level: 'province' })`
2. 获取省下城市：`getRegions({ parent_id: provinceId, region_level: 'city', province: provinceName })`  
3. 获取市下公司：`getRegions({ parent_id: cityId, region_level: 'company', province: provinceName, city: cityName })`

### 3. 后端接口需要支持的查询方式

#### `/api/v1/policy-management/regions`
**参数说明：**
- `region_level`: 必需，指定查询的层级
- `parent_id`: 可选，按父级ID查询子节点
- `province`: 可选，按省份名称过滤
- `city`: 可选，按城市名称过滤

**查询示例：**
```javascript
// 1. 获取所有省份
GET /api/v1/policy-management/regions?region_level=province

// 2. 获取指定省份下的所有城市
GET /api/v1/policy-management/regions?region_level=city&parent_id=1&province=广东省

// 3. 获取指定城市下的所有公司
GET /api/v1/policy-management/regions?region_level=company&parent_id=10&province=广东省&city=深圳市

// 4. 获取指定省份下的所有公司（用于复制政策功能）
GET /api/v1/policy-management/regions?region_level=company&province=广东省
```

### 4. 数据返回格式
```javascript
{
  "success": true,
  "data": {
    "regions": [
      {
        "region_id": 1,
        "region_level": "province",
        "province": "广东省",
        "city": null,
        "company": null,
        "region_code": "GD"
      },
      {
        "region_id": 10,
        "region_level": "city", 
        "province": "广东省",
        "city": "深圳市",
        "company": null,
        "region_code": "GD_SZ"
      },
      {
        "region_id": 100,
        "region_level": "company",
        "province": "广东省", 
        "city": "深圳市",
        "company": "深圳供电局",
        "region_code": "GD_SZ_001"
      }
    ]
  }
}
```

## 修复内容

### 前端修复
1. **PolicyNavigationTree.vue**: 添加完整的参数传递和数据继承逻辑
2. **CompanyPolicy.vue**: 改进错误处理和数据格式化
3. **policies.ts**: 扩展接口参数类型定义

### 需要后端配合的部分
1. **数据库表结构确认**: 确保三级关系正确建立
2. **接口实现**: 支持多种查询参数组合
3. **数据完整性**: 确保每个节点都包含完整的层级信息

## 测试方法

1. 在浏览器中加载测试脚本：
```javascript
// 在控制台运行
testPolicyAPI.testGetProvinces()
```

2. 逐级测试数据获取：
```javascript
// 假设广东省的region_id是1
testPolicyAPI.testGetCities(1, '广东省')
```

3. 测试政策数据获取：
```javascript
testPolicyAPI.testGetProvincePolicy(1)
```

## 建议的后端实现要点

1. **支持层级查询**: 通过parent_id快速获取子节点
2. **支持平级查询**: 通过province/city参数获取同级所有节点
3. **数据完整性**: 每个返回的节点都包含完整的层级路径信息
4. **性能优化**: 考虑添加缓存和分页支持