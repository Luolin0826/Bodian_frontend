# 前端权限系统集成指南

## 概述

本指南说明如何在前端页面中集成新的企业级权限系统，包括菜单权限、操作权限、数据权限和敏感数据脱敏功能。

## 1. 权限系统架构

### 权限类型
- **菜单权限**: 控制用户可以访问哪些页面
- **操作权限**: 控制用户可以执行哪些操作（增删改查等）
- **数据权限**: 控制用户可以查看哪些数据范围（全部/部门/个人）
- **敏感数据权限**: 控制敏感字段的访问和脱敏显示

### 权限格式
- 菜单权限: `["dashboard", "customer.list", "sales.record"]`
- 操作权限: `{"customer": ["create", "update", "delete"], "sales": ["view", "export"]}`
- 数据权限: `{scope: "department", regional_permissions: [...], sensitive: [...]}`

## 2. 在页面中集成权限检查

### 2.1 导入权限工具

```typescript
import { useDataPermission } from '@/utils/dataPermissions'
import MaskedText from '@/components/common/MaskedText.vue'

// 获取权限检查工具
const { 
  canPerformOperation,
  hasDataPermission,
  hasSensitiveAccess,
  filterDataList,
  processSensitiveDataList 
} = useDataPermission()
```

### 2.2 操作按钮权限控制

```vue
<template>
  <!-- 新增按钮 -->
  <a-button 
    v-if="canPerformOperation('customer', 'create')"
    type="primary" 
    @click="handleCreate"
  >
    新增客户
  </a-button>
  
  <!-- 编辑按钮 -->
  <a-button 
    v-if="canPerformOperation('customer', 'update')"
    @click="handleEdit(record)"
  >
    编辑
  </a-button>
  
  <!-- 删除按钮（高风险操作） -->
  <a-popconfirm 
    v-if="canPerformOperation('customer', 'delete', 'high')"
    title="确定要删除吗？"
    @confirm="handleDelete(record.id)"
  >
    <a-button danger>删除</a-button>
  </a-popconfirm>
</template>
```

### 2.3 数据过滤和脱敏

```typescript
// 加载数据时进行权限过滤
const loadData = async () => {
  try {
    const response = await getCustomers(params)
    
    // 根据用户数据权限过滤数据
    const filteredData = filterDataList(response.data, {
      dataType: 'customer_data',
      regionField: 'region',
      departmentField: 'department_id',
      creatorField: 'creator_id'
    })
    
    // 处理敏感数据脱敏
    const sensitiveFields = ['phone', 'email', 'wechat', 'id_card']
    dataList.value = processSensitiveDataList(filteredData, sensitiveFields)
    
  } catch (error) {
    message.error('加载数据失败')
  }
}
```

### 2.4 敏感数据显示

```vue
<template>
  <!-- 手机号脱敏显示 -->
  <MaskedText :value="record.phone" data-type="phone" />
  
  <!-- 邮箱脱敏显示 -->
  <MaskedText :value="record.email" data-type="email" />
  
  <!-- 身份证脱敏显示 -->
  <MaskedText :value="record.id_card" data-type="idcard" />
  
  <!-- 带权限申请按钮 -->
  <MaskedText 
    :value="record.salary" 
    data-type="money"
    :show-apply-button="true"
    @apply-access="handleApplyAccess"
  />
</template>
```

## 3. 权限检查最佳实践

### 3.1 页面级权限验证

```typescript
import { validatePermissions } from '@/utils/dataPermissions'

// 在组件挂载时验证权限
onMounted(() => {
  const hasPermission = validatePermissions({
    menu: ['customer.list'],
    operation: { customer: ['view'] },
    data: ['customer_data']
  })
  
  if (!hasPermission) {
    router.push('/403')
    return
  }
  
  loadData()
})
```

### 3.2 动态权限提示

```vue
<template>
  <a-alert
    v-if="!hasDataPermission('financial_data')"
    message="您没有财务数据查看权限"
    type="warning"
    show-icon
    class="permission-alert"
  />
  
  <a-empty 
    v-else-if="dataList.length === 0"
    description="暂无数据"
  />
</template>
```

### 3.3 权限状态显示

```vue
<template>
  <div class="permission-status">
    <a-tag color="blue">{{ getDataScopeDescription() }}</a-tag>
    <a-tag v-if="hasSensitiveAccess('phone')" color="green">可查看手机号</a-tag>
    <a-tag v-else color="orange">手机号已脱敏</a-tag>
  </div>
</template>
```

## 4. 错误处理和降级方案

### 4.1 权限检查失败处理

```typescript
const handleOperation = async (operation: string) => {
  if (!canPerformOperation('customer', operation)) {
    Modal.warning({
      title: '权限不足',
      content: '您没有执行此操作的权限，请联系管理员',
    })
    return
  }
  
  try {
    // 执行操作
    await performOperation()
    message.success('操作成功')
  } catch (error) {
    if (error.response?.status === 403) {
      message.error('权限验证失败，请重新登录')
    } else {
      message.error('操作失败')
    }
  }
}
```

### 4.2 权限降级显示

```vue
<template>
  <!-- 根据权限显示不同级别的信息 -->
  <div class="customer-info">
    <h3>{{ customer.name }}</h3>
    
    <!-- 基础信息：所有用户可见 -->
    <p>状态: {{ customer.status }}</p>
    
    <!-- 联系方式：需要权限 -->
    <div v-if="hasSensitiveAccess('phone')">
      <p>电话: {{ customer.phone }}</p>
    </div>
    <div v-else>
      <p>电话: <MaskedText :value="customer.phone" data-type="phone" /></p>
    </div>
    
    <!-- 财务信息：高权限用户可见 -->
    <div v-if="canPerformOperation('customer', 'view_financial')">
      <p>成交金额: ¥{{ customer.amount }}</p>
    </div>
  </div>
</template>
```

## 5. 调试和监控

### 5.1 权限调试

```typescript
// 开发环境下的权限调试信息
if (process.env.NODE_ENV === 'development') {
  console.log('用户权限信息:', {
    role: userStore.userInfo?.role,
    menuPermissions: userStore.permissions.menu,
    operationPermissions: userStore.permissions.operation,
    dataScope: userStore.permissions.data.scope,
    sensitiveAccess: userStore.permissions.data.sensitive
  })
}
```

### 5.2 权限变更监听

```typescript
import { watch } from 'vue'

// 监听权限变更
watch(
  () => userStore.permissions,
  (newPermissions) => {
    console.log('权限已更新:', newPermissions)
    // 重新加载数据或刷新页面状态
    loadData()
  },
  { deep: true }
)
```

## 6. 性能优化

### 6.1 权限缓存

```typescript
// 缓存权限检查结果
const permissionCache = new Map()

const cachedPermissionCheck = (key: string, checkFn: () => boolean) => {
  if (!permissionCache.has(key)) {
    permissionCache.set(key, checkFn())
  }
  return permissionCache.get(key)
}

// 在权限变更时清除缓存
watch(() => userStore.permissions, () => {
  permissionCache.clear()
})
```

### 6.2 按需加载敏感数据

```typescript
// 只在用户有权限时加载敏感数据
const loadSensitiveData = async () => {
  if (hasSensitiveAccess('financial_data')) {
    const financialData = await getFinancialData()
    // 处理财务数据
  }
}
```

## 7. 测试建议

### 7.1 权限测试用例

```typescript
// 权限功能测试
describe('权限系统测试', () => {
  it('应该根据用户角色显示不同的操作按钮', () => {
    // 模拟管理员用户
    mockUserRole('admin')
    expect(canPerformOperation('customer', 'delete')).toBe(true)
    
    // 模拟普通用户
    mockUserRole('viewer')
    expect(canPerformOperation('customer', 'delete')).toBe(false)
  })
  
  it('应该正确过滤数据', () => {
    const testData = [
      { id: 1, department_id: '1', creator_id: '1' },
      { id: 2, department_id: '2', creator_id: '2' }
    ]
    
    mockUserPermissions({ scope: 'department', department_permissions: ['1'] })
    const filtered = filterDataList(testData, { departmentField: 'department_id' })
    expect(filtered).toHaveLength(1)
  })
})
```

## 8. 常见问题

### Q: 权限检查失败怎么办？
A: 检查用户登录状态、权限配置是否正确、后端权限数据是否同步。

### Q: 敏感数据没有脱敏？
A: 检查用户是否有敏感数据访问权限、MaskedText组件是否正确使用。

### Q: 数据过滤不生效？
A: 检查数据权限配置、字段映射是否正确、filterDataList参数是否匹配。

### Q: 权限更新后页面没有刷新？
A: 确保监听了权限变更事件、组件的响应式更新是否正确。

---

通过以上集成指南，可以在任何业务页面中快速集成企业级权限控制功能。