<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•ä½ç»Ÿè®¡è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .debug-box { background: #e6f7ff; padding: 10px; margin: 10px 0; border-left: 4px solid #1890ff; font-family: monospace; font-size: 12px; }
        .result { background: #f6ffed; padding: 10px; margin: 10px 0; border-left: 4px solid #52c41a; }
        .error { background: #fff2f0; padding: 10px; margin: 10px 0; border-left: 4px solid #ff4d4f; }
        .step { margin: 10px 0; padding: 8px; background: white; border-radius: 4px; }
        .highlight { background: #fff1b8; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        button { padding: 10px 20px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #40a9ff; }
        textarea { width: 100%; height: 200px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å•ä½ç»Ÿè®¡è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h3>ğŸ“¥ 1. è¾“å…¥æ‚¨çš„APIå“åº”æ•°æ®</h3>
        <p>è¯·å°†ä» <code>/api/v1/data-search/search</code> è·å¾—çš„JSONå“åº”ç²˜è´´åˆ°ä¸‹é¢ï¼š</p>
        <textarea id="inputData" placeholder="è¯·ç²˜è´´æ‚¨çš„JSONæ•°æ®..."></textarea>
        <br>
        <button onclick="analyzeData()">ğŸ” åˆ†ææ•°æ®</button>
        <button onclick="loadSampleData()">ğŸ“‹ åŠ è½½ç¤ºä¾‹æ•°æ®</button>
    </div>
    
    <div class="section">
        <h3>ğŸ“Š 2. æ•°æ®ç»“æ„åˆ†æ</h3>
        <div id="dataStructureAnalysis"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ§® 3. å‰ç«¯é€»è¾‘æ¨¡æ‹Ÿ</h3>
        <div id="frontendLogicResults"></div>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ 4. é—®é¢˜è¯Šæ–­</h3>
        <div id="problemDiagnosis"></div>
    </div>

    <script>
        function loadSampleData() {
            const sampleData = {
                "total_records": 209,
                "unit_statistics": {
                    "available": true,
                    "covered_units": 3,
                    "units": [
                        {"unit_name": "æ¹–å—", "region": "åä¸­", "recruitment_count": 92, "percentage": 44.02},
                        {"unit_name": "å†€åŒ—åšæœ›", "region": "æœªçŸ¥", "recruitment_count": 77, "percentage": 36.84},
                        {"unit_name": "ç”˜è‚ƒ", "region": "è¥¿åŒ—", "recruitment_count": 40, "percentage": 19.14}
                    ]
                },
                "statistics": {
                    "university_level_distribution": {
                        "211å·¥ç¨‹": 19,
                        "985å·¥ç¨‹": 3,
                        "åŒä¸€æµ": 9,
                        "æ™®é€šæœ¬ç§‘": 148,
                        "æµ·å¤–é«˜æ ¡": 1,
                        "ç‹¬ç«‹å­¦é™¢": 29
                    },
                    "gender_distribution": {
                        "å¥³": 70,
                        "ç”·": 139
                    }
                }
            };
            
            document.getElementById('inputData').value = JSON.stringify(sampleData, null, 2);
            analyzeData();
        }
        
        function analyzeData() {
            const inputData = document.getElementById('inputData').value.trim();
            
            if (!inputData) {
                alert('è¯·å…ˆè¾“å…¥æ•°æ®ï¼');
                return;
            }
            
            try {
                const data = JSON.parse(inputData);
                
                // 1. æ•°æ®ç»“æ„åˆ†æ
                analyzeDataStructure(data);
                
                // 2. æ¨¡æ‹Ÿå‰ç«¯é€»è¾‘
                simulateFrontendLogic(data);
                
                // 3. é—®é¢˜è¯Šæ–­
                diagnoseProblem(data);
                
            } catch (error) {
                alert('JSONæ ¼å¼é”™è¯¯: ' + error.message);
            }
        }
        
        function analyzeDataStructure(data) {
            const analysis = document.getElementById('dataStructureAnalysis');
            let html = '';
            
            // æ£€æŸ¥å…³é”®å­—æ®µ
            const checks = [
                {
                    name: 'unit_statistics å­—æ®µå­˜åœ¨',
                    condition: !!data.unit_statistics,
                    value: !!data.unit_statistics
                },
                {
                    name: 'unit_statistics.available',
                    condition: data.unit_statistics?.available === true,
                    value: data.unit_statistics?.available
                },
                {
                    name: 'unit_statistics.covered_units',
                    condition: typeof data.unit_statistics?.covered_units === 'number',
                    value: data.unit_statistics?.covered_units
                },
                {
                    name: 'unit_statistics.units æ•°ç»„',
                    condition: Array.isArray(data.unit_statistics?.units),
                    value: data.unit_statistics?.units?.length || 0
                },
                {
                    name: 'statistics å­—æ®µå­˜åœ¨',
                    condition: !!data.statistics,
                    value: !!data.statistics
                }
            ];
            
            checks.forEach(check => {
                const status = check.condition ? 'âœ…' : 'âŒ';
                const className = check.condition ? 'result' : 'error';
                html += `<div class="${className}">${status} <strong>${check.name}</strong>: ${check.value}</div>`;
            });
            
            // æ˜¾ç¤ºåŸå§‹æ•°æ®ç»“æ„
            html += '<h4>ğŸ“‹ åŸå§‹æ•°æ®ç»“æ„ï¼š</h4>';
            html += '<div class="debug-box">' + JSON.stringify({
                total_records: data.total_records,
                unit_statistics: data.unit_statistics,
                statistics: data.statistics
            }, null, 2) + '</div>';
            
            analysis.innerHTML = html;
        }
        
        function simulateFrontendLogic(backendData) {
            const results = document.getElementById('frontendLogicResults');
            let html = '<h4>ğŸ§® æ¨¡æ‹Ÿå‰ç«¯DataAnalytics.vueé€»è¾‘ï¼š</h4>';
            
            // æ¨¡æ‹ŸAPIé€‚é…å±‚ (recruitment.ts)
            const adaptedData = {
                analytics: {
                    total_count: backendData.total_records,
                    unit_statistics: backendData.unit_statistics,
                    university_level_distribution: backendData.statistics?.university_level_distribution,
                    gender_distribution: backendData.statistics?.gender_distribution
                }
            };
            
            html += '<div class="step"><strong>æ­¥éª¤1: APIé€‚é…å±‚å¤„ç†</strong></div>';
            html += '<div class="debug-box">props.data = ' + JSON.stringify(adaptedData, null, 2) + '</div>';
            
            // æ¨¡æ‹Ÿå‰ç«¯è®¡ç®—é€»è¾‘
            html += '<div class="step"><strong>æ­¥éª¤2: å‰ç«¯computedè®¡ç®—</strong></div>';
            
            // secondaryUnitsCount è®¡ç®—
            let secondaryUnitsCount = 0;
            if (adaptedData.analytics?.unit_statistics?.covered_units !== undefined) {
                secondaryUnitsCount = adaptedData.analytics.unit_statistics.covered_units;
                html += '<div class="result">âœ… secondaryUnitsCount = ' + secondaryUnitsCount + ' (ä½¿ç”¨covered_unitså­—æ®µ)</div>';
            } else if (adaptedData.analytics?.unit_statistics?.units) {
                const units = adaptedData.analytics.unit_statistics.units;
                const validUnits = units.filter(unit => (unit.recruitment_count || 0) > 0);
                secondaryUnitsCount = validUnits.length;
                html += '<div class="result">âœ… secondaryUnitsCount = ' + secondaryUnitsCount + ' (ç»Ÿè®¡æœ‰æ•ˆunitsæ•°é‡)</div>';
            } else {
                html += '<div class="error">âŒ æ— æ³•è®¡ç®—secondaryUnitsCount</div>';
            }
            
            // regionChartTitle è®¡ç®—
            let regionChartTitle = 'äºŒçº§å•ä½åˆ†å¸ƒ';
            if (adaptedData.analytics?.unit_statistics?.units) {
                const units = adaptedData.analytics.unit_statistics.units;
                const provinceLevelKeywords = ['å±±ä¸œ', 'æ±Ÿè‹', 'æµ™æ±Ÿ', 'æ²³å—', 'å››å·', 'æ¹–åŒ—', 'ç¦å»º', 'å®‰å¾½', 'æ¹–å—', 'é™•è¥¿', 'æ±Ÿè¥¿', 'è¾½å®', 'é»‘é¾™æ±Ÿ', 'æ–°ç–†', 'ç”˜è‚ƒ', 'æ²³åŒ—', 'å±±è¥¿', 'é‡åº†', 'é’æµ·', 'å‰æ—', 'å®å¤', 'ä¸Šæµ·', 'åŒ—äº¬', 'å¤©æ´¥', 'è¥¿è—'];
                
                const hasSubUnits = units.some(unit => {
                    const unitName = unit.unit_name || '';
                    if (provinceLevelKeywords.includes(unitName)) return false;
                    return unitName.includes('ä¾›ç”µå±€') || unitName.includes('è¶…é«˜å‹å…¬å¸') || 
                           unitName.includes('ç”µåŠ›ç§‘å­¦ç ”ç©¶é™¢') || unitName.includes('åˆ†å…¬å¸') ||
                           unitName.includes('åˆ†éƒ¨') || unitName.includes('äº§ä¸šé›†å›¢');
                });
                
                regionChartTitle = hasSubUnits ? 'ä¸‹å±å•ä½åˆ†å¸ƒ' : 'äºŒçº§å•ä½åˆ†å¸ƒ';
                html += '<div class="result">âœ… regionChartTitle = "' + regionChartTitle + '"</div>';
            }
            
            // å›¾è¡¨æ•°æ®è®¡ç®—
            let chartData = [];
            if (adaptedData.analytics?.unit_statistics?.units) {
                const units = adaptedData.analytics.unit_statistics.units;
                chartData = units
                    .filter(unit => (unit.recruitment_count || 0) > 0)
                    .map(unit => ({
                        name: unit.unit_name || 'æœªçŸ¥',
                        value: unit.recruitment_count || 0,
                        region: unit.region || 'æœªçŸ¥',
                        percentage: unit.percentage || 0
                    }));
                html += '<div class="result">âœ… å›¾è¡¨æ•°æ®: ' + chartData.length + ' ä¸ªå•ä½</div>';
                html += '<div class="debug-box">' + JSON.stringify(chartData, null, 2) + '</div>';
            } else {
                html += '<div class="error">âŒ æ— æ³•ç”Ÿæˆå›¾è¡¨æ•°æ®</div>';
            }
            
            results.innerHTML = html;
            
            // è¿”å›ç»“æœä¾›è¯Šæ–­ä½¿ç”¨
            return {
                secondaryUnitsCount,
                regionChartTitle,
                chartData,
                adaptedData
            };
        }
        
        function diagnoseProblem(data) {
            const diagnosis = document.getElementById('problemDiagnosis');
            let html = '<h4>ğŸ” é—®é¢˜è¯Šæ–­ç»“æœï¼š</h4>';
            
            const frontendResult = simulateFrontendLogic(data);
            
            // æ£€æŸ¥å¸¸è§é—®é¢˜
            const issues = [];
            
            if (!data.unit_statistics) {
                issues.push('âŒ åç«¯å“åº”ç¼ºå°‘ unit_statistics å­—æ®µ');
            } else if (!data.unit_statistics.available) {
                issues.push('âš ï¸ unit_statistics.available = falseï¼Œå¯èƒ½å½±å“å‰ç«¯æ˜¾ç¤º');
            } else if (data.unit_statistics.covered_units === 0) {
                issues.push('âš ï¸ covered_units = 0ï¼Œå¯èƒ½æ²¡æœ‰æœ‰æ•ˆçš„å•ä½æ•°æ®');
            } else if (!Array.isArray(data.unit_statistics.units) || data.unit_statistics.units.length === 0) {
                issues.push('âŒ unit_statistics.units æ•°ç»„ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
            }
            
            if (issues.length === 0) {
                html += '<div class="result">âœ… <strong>æ•°æ®ç»“æ„æ­£å¸¸ï¼</strong></div>';
                html += '<div class="result">ğŸ“Š é¢„æœŸæ˜¾ç¤ºæ•ˆæœï¼š</div>';
                html += '<div class="step">â€¢ è¦†ç›–äºŒçº§å•ä½: <span class="highlight">' + frontendResult.secondaryUnitsCount + '</span></div>';
                html += '<div class="step">â€¢ å›¾è¡¨æ ‡é¢˜: <span class="highlight">' + frontendResult.regionChartTitle + '</span></div>';
                html += '<div class="step">â€¢ å›¾è¡¨æ˜¾ç¤º: <span class="highlight">' + frontendResult.chartData.length + ' ä¸ªå•ä½</span></div>';
                
                html += '<div class="result">ğŸ¤” <strong>å¦‚æœå‰ç«¯ä»ç„¶ä¸æ˜¾ç¤ºï¼Œå¯èƒ½çš„åŸå› ï¼š</strong></div>';
                html += '<div class="step">1. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸåˆ°è¾¾å‰ç«¯ç»„ä»¶</div>';
                html += '<div class="step">2. æ£€æŸ¥Vueç»„ä»¶çš„propsæ˜¯å¦æ­£ç¡®ä¼ é€’</div>';
                html += '<div class="step">3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯</div>';
                html += '<div class="step">4. æ£€æŸ¥ç»„ä»¶æ˜¯å¦æ­£ç¡®æ›´æ–°å’Œé‡æ–°æ¸²æŸ“</div>';
            } else {
                html += '<div class="error"><strong>å‘ç°é—®é¢˜ï¼š</strong></div>';
                issues.forEach(issue => {
                    html += '<div class="step">' + issue + '</div>';
                });
            }
            
            // æä¾›è§£å†³æ–¹æ¡ˆ
            html += '<div class="result">ğŸ› ï¸ <strong>è°ƒè¯•å»ºè®®ï¼š</strong></div>';
            html += '<div class="step">1. åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æ£€æŸ¥ç½‘ç»œè¯·æ±‚</div>';
            html += '<div class="step">2. åœ¨Vueç»„ä»¶ä¸­æ·»åŠ console.log(props.data)æŸ¥çœ‹æ•°æ®</div>';
            html += '<div class="step">3. æ£€æŸ¥DataAnalyticsç»„ä»¶æ˜¯å¦è¢«æ­£ç¡®æ¸²æŸ“</div>';
            html += '<div class="step">4. ç¡®è®¤æ•°æ®æ›´æ–°æ—¶ç»„ä»¶é‡æ–°è®¡ç®—äº†computedå±æ€§</div>';
            
            diagnosis.innerHTML = html;
        }
    </script>
</body>
</html>