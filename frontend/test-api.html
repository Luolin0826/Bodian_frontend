<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d1edff; color: #0c5460; }
        input { padding: 8px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
        .token-display { word-break: break-all; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>åç«¯APIæµ‹è¯•é¡µé¢</h1>
        
        <!-- é…ç½®éƒ¨åˆ† -->
        <div class="test-section">
            <h3>ğŸ”§ é…ç½®</h3>
            <label>åç«¯åœ°å€: 
                <input type="text" id="baseUrl" value="http://dev_backend:5000" placeholder="http://dev_backend:5000">
            </label>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="connectionResult" class="result" style="display:none;"></div>
        </div>

        <!-- å¥åº·æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ’š å¥åº·æ£€æŸ¥ (æ— éœ€è®¤è¯)</h3>
            <button onclick="testHealth()">æµ‹è¯• /api/health</button>
            <button onclick="testCustomerHealth()">æµ‹è¯• /api/v1/customers/health</button>
            <div id="healthResult" class="result" style="display:none;"></div>
        </div>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ” ç™»å½•æµ‹è¯•</h3>
            <div>
                <label>ç”¨æˆ·å: <input type="text" id="username" value="admin" placeholder="ç”¨æˆ·å"></label>
                <label>å¯†ç : <input type="password" id="password" value="password" placeholder="å¯†ç "></label>
            </div>
            <button onclick="testLogin()">ç™»å½•</button>
            <button onclick="clearToken()">æ¸…é™¤Token</button>
            <div id="loginResult" class="result" style="display:none;"></div>
            <div id="tokenDisplay" class="result token-display" style="display:none;"></div>
        </div>

        <!-- è®¤è¯APIæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ›¡ï¸ è®¤è¯APIæµ‹è¯• (éœ€è¦JWT)</h3>
            <button onclick="testCustomerList()">æµ‹è¯•å®¢æˆ·åˆ—è¡¨ GET /api/v1/customers</button>
            <button onclick="testUserInfo()">æµ‹è¯•ç”¨æˆ·ä¿¡æ¯ GET /auth/me</button>
            <div id="authResult" class="result" style="display:none;"></div>
        </div>

        <!-- JWTä¿¡æ¯æ˜¾ç¤º -->
        <div class="test-section">
            <h3>ğŸ” JWTä¿¡æ¯</h3>
            <button onclick="decodeJWT()">è§£æå½“å‰JWT</button>
            <div id="jwtInfo" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        let currentToken = localStorage.getItem('token') || '';

        // è·å–åŸºç¡€URL
        function getBaseUrl() {
            return document.getElementById('baseUrl').value.replace(/\/$/, '');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(content, null, 2);
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                const response = await fetch(getBaseUrl() + '/');
                const result = await response.text();
                showResult('connectionResult', { 
                    status: response.status, 
                    statusText: response.statusText,
                    body: result 
                }, !response.ok);
            } catch (error) {
                showResult('connectionResult', { error: error.message }, true);
            }
        }

        // æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealth() {
            try {
                const response = await fetch(getBaseUrl() + '/api/health');
                const result = await response.json();
                showResult('healthResult', { 
                    endpoint: '/api/health',
                    status: response.status,
                    data: result 
                }, !response.ok);
            } catch (error) {
                showResult('healthResult', { 
                    endpoint: '/api/health',
                    error: error.message 
                }, true);
            }
        }

        // æµ‹è¯•å®¢æˆ·æ¨¡å—å¥åº·æ£€æŸ¥
        async function testCustomerHealth() {
            try {
                const response = await fetch(getBaseUrl() + '/api/v1/customers/health');
                const result = await response.json();
                showResult('healthResult', { 
                    endpoint: '/api/v1/customers/health',
                    status: response.status,
                    data: result 
                }, !response.ok);
            } catch (error) {
                showResult('healthResult', { 
                    endpoint: '/api/v1/customers/health',
                    error: error.message 
                }, true);
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(getBaseUrl() + '/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.access_token) {
                    currentToken = result.access_token;
                    localStorage.setItem('token', currentToken);
                    
                    // æ˜¾ç¤ºtokenä¿¡æ¯
                    document.getElementById('tokenDisplay').style.display = 'block';
                    document.getElementById('tokenDisplay').textContent = 'Tokenå·²ä¿å­˜: ' + currentToken;
                    
                    showResult('loginResult', result, false);
                } else {
                    showResult('loginResult', result, true);
                }
            } catch (error) {
                showResult('loginResult', { error: error.message }, true);
            }
        }

        // æ¸…é™¤Token
        function clearToken() {
            currentToken = '';
            localStorage.removeItem('token');
            document.getElementById('tokenDisplay').style.display = 'none';
            showResult('loginResult', { message: 'Tokenå·²æ¸…é™¤' }, false);
        }

        // æµ‹è¯•å®¢æˆ·åˆ—è¡¨
        async function testCustomerList() {
            if (!currentToken) {
                showResult('authResult', { error: 'è¯·å…ˆç™»å½•è·å–Token' }, true);
                return;
            }

            try {
                const response = await fetch(getBaseUrl() + '/api/v1/customers?page=1&per_page=20', {
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                showResult('authResult', {
                    endpoint: '/api/v1/customers',
                    status: response.status,
                    data: result
                }, !response.ok);
            } catch (error) {
                showResult('authResult', { 
                    endpoint: '/api/v1/customers',
                    error: error.message 
                }, true);
            }
        }

        // æµ‹è¯•ç”¨æˆ·ä¿¡æ¯
        async function testUserInfo() {
            if (!currentToken) {
                showResult('authResult', { error: 'è¯·å…ˆç™»å½•è·å–Token' }, true);
                return;
            }

            try {
                const response = await fetch(getBaseUrl() + '/api/v1/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                showResult('authResult', {
                    endpoint: '/api/v1/auth/me',
                    status: response.status,
                    data: result
                }, !response.ok);
            } catch (error) {
                showResult('authResult', { 
                    endpoint: '/api/v1/auth/me',
                    error: error.message 
                }, true);
            }
        }

        // è§£æJWT
        function decodeJWT() {
            if (!currentToken) {
                showResult('jwtInfo', { error: 'æ²¡æœ‰æ‰¾åˆ°JWT Token' }, true);
                return;
            }

            try {
                const parts = currentToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }

                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                // è½¬æ¢æ—¶é—´æˆ³ä¸ºå¯è¯»æ ¼å¼
                if (payload.exp) payload.exp_readable = new Date(payload.exp * 1000).toLocaleString();
                if (payload.iat) payload.iat_readable = new Date(payload.iat * 1000).toLocaleString();

                showResult('jwtInfo', {
                    header,
                    payload,
                    signature: parts[2]
                }, false);
            } catch (error) {
                showResult('jwtInfo', { error: 'JWTè§£æå¤±è´¥: ' + error.message }, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„token
        window.onload = function() {
            if (currentToken) {
                document.getElementById('tokenDisplay').style.display = 'block';
                document.getElementById('tokenDisplay').textContent = 'Tokenå·²ä¿å­˜: ' + currentToken;
            }
        };
    </script>
</body>
</html>