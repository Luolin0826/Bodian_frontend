// 本地头像映射数据 (同步版本，作为 fallback)
const avatarMap: Record<string, string> = {
  'cat': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGQjZDMSIvPgogIDxjaXJjbGUgY3g9IjM1IiBjeT0iMzUiIHI9IjgiIGZpbGw9IiNGRjY5QjQiLz4KICA8Y2lyY2xlIGN4PSI2NSIgY3k9IjM1IiByPSI4IiBmaWxsPSIjRkY2OUI0Ii8+CiAgPGNpcmNsZSBjeD0iNDAiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8cGF0aCBkPSJNNDUgNTUgUTUwIDYwIDU1IDU1IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgogIDxwYXRoIGQ9Ik0zNSAyNSBRNDAgMTUgNDUgMjUiIGZpbGw9IiNGRjY5QjQiLz4KICA8cGF0aCBkPSJNNTUgMjUgUTYwIDE1IDY1IDI1IiBmaWxsPSIjRkY2OUI0Ii8+Cjwvc3ZnPg==',
  'dog': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0RFQjg4NyIvPgogIDxlbGxpcHNlIGN4PSIzMCIgY3k9IjMwIiByeD0iMTIiIHJ5PSIyMCIgZmlsbD0iI0RFQjg4NyIvPgogIDxlbGxpcHNlIGN4PSI3MCIgY3k9IjMwIiByeD0iMTIiIHJ5PSIyMCIgZmlsbD0iI0RFQjg4NyIvPgogIDxjaXJjbGUgY3g9IjQyIiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQ1IiByPSIzIiBmaWxsPSIjMDAwIi8+CiAgPGVsbGlwc2UgY3g9IjUwIiBjeT0iNTUiIHJ4PSI4IiByeT0iNiIgZmlsbD0iIzAwMCIvPgogIDxwYXRoIGQ9Ik00MiA2MCBRNTEGOTY1IDU4IDYwIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4=',
  'bear': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0NEODUzRiIvPgogIDxjaXJjbGUgY3g9IjI1IiBjeT0iMjUiIHI9IjE1IiBmaWxsPSIjQ0Q4NTNGIi8+CiAgPGNpcmNsZSBjeD0iNzUiIGN5PSIyNSIgcj0iMTUiIGZpbGw9IiNDRDg1M0YiLz4KICA8Y2lyY2xlIGN4PSI0MiIgY3k9IjQ1IiByPSIzIiBmaWxsPSIjMDAwIi8+CiAgPGNpcmNsZSBjeD0iNTgiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9IjU1IiByeD0iNiIgcnk9IjQiIGZpbGw9IiMwMDAiLz4KICA8cGF0aCBkPSJNNDIgNjIgUTUwIDY3IDU4IDYyIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4=',
  'rabbit': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0Y1RjVEQyIvPgogIDxlbGxpcHNlIGN4PSIzNSIgY3k9IjE1IiByeD0iOCIgcnk9IjI1IiBmaWxsPSIjRjVGNURDIi8+CiAgPGVsbGlwc2UgY3g9IjY1IiBjeT0iMTUiIHJ4PSI4IiByeT0iMjUiIGZpbGw9IiNGNUY1REMiLz4KICA8ZWxsaXBzZSBjeD0iMzUiIGN5PSIxOCIgcng9IjQiIHJ5PSIxOCIgZmlsbD0iI0ZGQjZDMSIvPgogIDxlbGxpcHNlIGN4PSI2NSIgY3k9IjE4IiByeD0iNCIgcnk9IjE4IiBmaWxsPSIjRkZCNkMxIi8+CiAgPGNpcmNsZSBjeD0iNDIiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxjaXJjbGUgY3g9IjU4IiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8cGF0aCBkPSJNNDUgNTUgUTUwIDU4IDU1IDU1IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4=',
  'panda': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGRkZGRiIvPgogIDxjaXJjbGUgY3g9IjMwIiBjeT0iMzAiIHI9IjE1IiBmaWxsPSIjMDAwIi8+CiAgPGNpcmNsZSBjeD0iNzAiIGN5PSIzMCIgcj0iMTUiIGZpbGw9IiMwMDAiLz4KICA8Y2lyY2xlIGN4PSIzNSIgY3k9IjMwIiByPSIxMiIgZmlsbD0iI0ZGRkZGRiIvPgogIDxjaXJjbGUgY3g9IjY1IiBjeT0iMzAiIHI9IjEyIiBmaWxsPSIjRkZGRkZGIi8+CiAgPGNpcmNsZSBjeD0iNDIiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxjaXJjbGUgY3g9IjU4IiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8ZWxsaXBzZSBjeD0iNTAiIGN5PSI1NSIgcng9IjYiIHJ5PSI0IiBmaWxsPSIjMDAwIi8+CiAgPHBhdGggZD0iTTQyIDYyIFE1MCA2NyA1OCA2MiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
  'fox': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGOEMwMCIvPgogIDxwb2x5Z29uIHBvaW50cz0iMzUsMjUgNDUsNSA1NSwyNSIgZmlsbD0iI0ZGOEMwMCIvPgogIDxwb2x5Z29uIHBvaW50cz0iNTUsMjUgNjUsNSA3NSwyNSIgZmlsbD0iI0ZGOEMwMCIvPgogIDxwb2x5Z29uIHBvaW50cz0iNDIsMjAgNDgsMTAgNTIsMjAiIGZpbGw9IiNGRkZGRkYiLz4KICA8cG9seWdvbiBwb2ludHM9IjU4LDIwIDYyLDEwIDY4LDIwIiBmaWxsPSIjRkZGRkZGIi8+CiAgPGNpcmNsZSBjeD0iNDIiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxjaXJjbGUgY3g9IjU4IiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8ZWxsaXBzZSBjeD0iNTAiIGN5PSI1NSIgcng9IjYiIHJ5PSI0IiBmaWxsPSIjMDAwIi8+CiAgPHBhdGggZD0iTTQyIDYyIFE1MCA2NyA1OCA2MiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
  'robot': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB4PSIyMCIgeT0iMzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjEwIiBmaWxsPSIjNDE2OUUxIi8+CiAgPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iOCIgZmlsbD0iIzQxNjlFMSIvPgogIDxjaXJjbGUgY3g9IjgwIiBjeT0iMjAiIHI9IjgiIGZpbGw9IiM0MTY5RTEiLz4KICA8cmVjdCB4PSIzNSIgeT0iNDAiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiMwMEZGMDAiLz4KICA8cmVjdCB4PSI1NyIgeT0iNDAiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiMwMEZGMDAiLz4KICA8cmVjdCB4PSI0MiIgeT0iNTUiIHdpZHRoPSIxNiIgaGVpZ2h0PSI0IiBmaWxsPSIjRkZGRkZGIi8+CiAgPHJlY3QgeD0iMjUiIHk9Ijg1IiB3aWR0aD0iMTIiIGhlaWdodD0iOCIgZmlsbD0iIzQxNjlFMSIvPgogIDxyZWN0IHg9IjYzIiB5PSI4NSIgd2lkdGg9IjEyIiBoZWlnaHQ9IjgiIGZpbGw9IiM0MTY5RTEiLz4KPC9zdmc+',
  'princess': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGREJBQyIvPgogIDxwYXRoIGQ9Ik0yMCAzMCBRMzAgMTAgNTAgMTAgUTcwIDEwIDgwIDMwIFE3NSAyNSA2NSAyNSBRNTUgMjAgNTAgMjAgUTQ1IDIwIDM1IDI1IFEyNSAyNSAyMCAzMCIgZmlsbD0iI0ZGRDcwMCIvPgogIDxjaXJjbGUgY3g9IjQyIiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQ1IiByPSIzIiBmaWxsPSIjMDAwIi8+CiAgPHBhdGggZD0iTTQyIDU1IFE1MCA2MCA1OCA1NSIgc3Ryb2tlPSIjRkYxNDkzIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KICA8Y2lyY2xlIGN4PSIzNSIgY3k9IjM4IiByPSI0IiBmaWxsPSIjRkY2OUI0Ii8+CiAgPGNpcmNsZSBjeD0iNjUiIGN5PSIzOCIgcj0iNCIgZmlsbD0iI0ZGNjlCNCIvPgo8L3N2Zz4=',
  'superhero': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGREJBQyIvPgogIDxwYXRoIGQ9Ik0yNSAyNSBRNDAgMTUgNTAgMTUgUTYwIDE1IDc1IDI1IFE3MCAyMCA2MCAyMCBRNTAgMTggNDAgMjAgUTMwIDIwIDI1IDI1IiBmaWxsPSIjMDAwIi8+CiAgPGNpcmNsZSBjeD0iNDIiIGN5PSI0NSIgcj0iMyIgZmlsbD0iIzAwMCIvPgogIDxjaXJjbGUgY3g9IjU4IiBjeT0iNDUiIHI9IjMiIGZpbGw9IiMwMDAiLz4KICA8cGF0aCBkPSJNNDIgNTUgUTUwIDYwIDU4IDU1IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgogIDxyZWN0IHg9IjM1IiB5PSI3MCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjE1IiBmaWxsPSIjREMxNDNDIi8+CiAgPHBvbHlnb24gcG9pbnRzPSI0NSw3NSA1MCw3MCA1NSw3NSIgZmlsbD0iI0ZGRDcwMCIvPgo8L3N2Zz4=',
  'smile': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGRDcwMCIvPgogIDxjaXJjbGUgY3g9IjM1IiBjeT0iNDAiIHI9IjUiIGZpbGw9IiMwMDAiLz4KICA8Y2lyY2xlIGN4PSI2NSIgY3k9IjQwIiByPSI1IiBmaWxsPSIjMDAwIi8+CiAgPHBhdGggZD0iTTMwIDYwIFE1MCA4MCA3MCA2MCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjQiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
  'wink': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGRDcwMCIvPgogIDxwYXRoIGQ9Ik0zMCAzOCBRMzUgNDIgNDAgMzgiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+CiAgPGNpcmNsZSBjeD0iNjUiIGN5PSI0MCIgcj0iNSIgZmlsbD0iIzAwMCIvPgogIDxwYXRoIGQ9Ik0zMCA2MCBRNTMGOCA3MCA2MCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjQiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
  'cool': 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI0ZGRDcwMCIvPgogIDxyZWN0IHg9IjI1IiB5PSIzNSIgd2lkdGg9IjUwIiBoZWlnaHQ9IjEyIiByeD0iNiIgZmlsbD0iIzAwMCIvPgogIDxyZWN0IHg9IjMwIiB5PSIzNyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjgiIHJ4PSI0IiBmaWxsPSIjMzMzIi8+CiAgPHJlY3QgeD0iNTIiIHk9IjM3IiB3aWR0aD0iMTgiIGhlaWdodD0iOCIgcng9IjQiIGZpbGw9IiMzMzMiLz4KICA8cGF0aCBkPSJNMzUgNjUgUTUwIDcwIDY1IDY1IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4='
}

/**
 * 获取显示用的头像URL (同步版本)
 * @param avatarValue 用户头像值
 * @returns 可显示的头像URL
 */
export function getDisplayAvatar(avatarValue?: string): string {
  if (!avatarValue || avatarValue.trim() === '') {
    return avatarMap['cat'] // 默认小猫头像
  }
  
  try {
    // 如果是完整的URL，直接返回
    if (avatarValue.startsWith('http') || avatarValue.startsWith('data:')) {
      return avatarValue
    }
    
    // 如果是头像ID，查找对应的URL
    if (avatarMap[avatarValue]) {
      return avatarMap[avatarValue]
    }
    
    // 如果包含SVG标签，转换为data URL（兼容旧版本）
    if (avatarValue.includes('<svg')) {
      return svgToDataUrl(avatarValue)
    }
    
    console.warn(`未知的头像值格式: ${avatarValue}，使用默认头像`)
    return avatarMap['cat']
  } catch (error) {
    console.error('处理头像显示时出错:', error, '原始值:', avatarValue)
    return avatarMap['cat']
  }
}

/**
 * 检查是否为头像ID
 * @param value 头像值
 * @returns 是否为头像ID
 */
export function isAvatarId(value?: string): boolean {
  if (!value) return false
  
  // 如果是完整的URL，返回false
  if (value.startsWith('http') || value.startsWith('data:')) {
    return false
  }
  
  // 如果包含SVG标签，返回false（旧版本的SVG代码）
  if (value.includes('<svg') || value.includes('</svg>')) {
    return false
  }
  
  // 检查是否在预定义映射中
  return avatarMap.hasOwnProperty(value)
}

/**
 * 默认头像ID
 */
export const DEFAULT_AVATAR = 'cat'

/**
 * SVG转base64 data URL (保持兼容性)
 * @param svgString SVG字符串
 * @returns base64 data URL
 */
export function svgToDataUrl(svgString: string): string {
  return `data:image/svg+xml;base64,${btoa(svgString)}`
}