# 三级政策管理系统 - 城市层级展开问题排查指南

## 问题描述
用户反馈：发送获取福建省城市的请求后，返回了正确的城市数据，但在前端无法正常展开对应的层次，显示有问题。

## API请求和响应分析

### 请求
```
GET http://localhost:8088/api/v1/policy-management/regions?parent_id=29&region_level=city&province=福建
```

### 响应数据
```json
{
  "data": {
    "regions": [
      {
        "city": "福州",
        "company": null,
        "created_at": "Wed, 03 Sep 2025 21:55:59 GMT",
        "is_active": 1,
        "is_municipality": 0,
        "parent_region_id": 29,
        "province": "福建",
        "region_code": "CITY_福建_福州",
        "region_id": 237,
        "region_level": "city",
        "sort_order": 0,
        "updated_at": "Wed, 03 Sep 2025 21:55:59 GMT"
      }
      // ... 其他8个城市
    ]
  },
  "success": true
}
```

## 已实施的修复措施

### 1. 优化树节点选择逻辑
**问题**: 城市节点被选中时会阻止展开操作
**修复**: 修改 `handleTreeSelect` 函数，允许城市节点展开但不进行编辑

```javascript
// 修复前：直接返回，阻止所有后续操作
if (selectedNode.region_level === 'city') {
  message.info('市级主要起连接作用，请选择省份或区县公司进行编辑')
  return
}

// 修复后：清除选中但不阻止展开
if (selectedNode.region_level === 'city') {
  selectedKeys.value = []
  message.info('市级主要起连接作用，请展开查看下级区县公司')
  return
}
```

### 2. 改进数据继承逻辑
**问题**: 子节点缺少完整的层级信息
**修复**: 确保子节点正确继承父节点信息

```javascript
// 修复前
city: region.city || (region.region_level === 'company' ? parentNode.city : undefined),

// 修复后
city: region.city || parentNode.city, // 简化继承逻辑
```

### 3. 增强调试和日志
**添加的调试信息**:
- 展开事件详细日志
- 子节点数据处理过程跟踪
- 异步加载状态监控

### 4. 创建独立测试组件
**目标**: 便于调试树形组件功能
**文件**: `/src/components/TreeTest.vue`
**访问**: `/tree-test` 路由

## 排查步骤

### 第一步：检查控制台日志
打开浏览器开发者工具，查看以下日志：

1. **展开事件日志**:
```
树节点展开事件: {
  expanded: true,
  nodeData: {...},
  hasChildren: false,
  expandedKeys: [...]
}
```

2. **数据加载日志**:
```
加载子节点: {
  parentLevel: "province",
  parentId: 29,
  province: "福建"
}
获取到子节点数据: [...]
处理后的子节点数据: [...]
最终生成的子节点: [...]
```

### 第二步：验证API响应
确认API返回的数据格式正确：
- `region_id` 存在且为数字
- `region_level` 为 "city"
- `province` 和 `city` 字段正确
- `parent_region_id` 匹配请求的 `parent_id`

### 第三步：检查树组件状态
使用测试页面 `/tree-test` 查看：
- 展开状态是否正确更新
- 子节点数据是否正确加载
- 选中状态是否干扰展开

### 第四步：验证Unicode字符处理
福建省的城市名称包含中文字符，确认：
- 显示名称正确
- 搜索功能正常
- 节点标题无乱码

## 可能的其他问题

### 1. 网络请求问题
- 检查网络请求是否成功
- 验证URL编码是否正确
- 确认服务器响应时间合理

### 2. Vue响应式更新问题  
- 确保树数据的响应式更新
- 检查组件重渲染是否正常
- 验证计算属性是否正确触发

### 3. Ant Design Vue版本兼容
- 确认Tree组件版本兼容性
- 检查懒加载配置是否正确
- 验证异步数据加载逻辑

## 测试用例

### 手动测试步骤：
1. 访问三级政策管理页面
2. 点击"福建"省份节点左侧的展开图标
3. 观察是否显示城市列表
4. 点击任一城市节点（如"福州"）
5. 观察是否显示区县公司列表

### 自动化测试（可选）：
创建测试脚本验证树形组件的展开功能

## 解决方案总结

通过以上修复措施，应该能够解决城市层级展开问题。主要改进包括：

1. **分离选中和展开逻辑** - 城市节点可以展开但不会被编辑
2. **完善数据继承** - 确保所有层级信息正确传递  
3. **增强调试能力** - 提供详细日志便于问题排查
4. **创建测试工具** - 独立测试组件便于功能验证

如果问题仍然存在，请查看浏览器控制台的具体日志信息，并对照本指南进行进一步排查。